{% extends "home/layouts/base.html" %}
{% load static  %}

{% block content %}
<section class="bg-half-170 bg-light d-table w-100">
    <div class="container">
        <div class="row mt-5 justify-content-center">
            <div class="col-lg-12 text-center">
                <div class="pages-heading">
                    <h4 class="title mb-0"> Register </h4>
                </div>
            </div>  <!--end col-->
        </div><!--end row-->
        
        <div class="position-breadcrumb">
            <nav aria-label="breadcrumb" class="d-inline-block">
                <ul class="breadcrumb rounded shadow mb-0 px-4 py-2">
                    <li class="breadcrumb-item"><a href="#">Page</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Register</li>
                </ul>
            </nav>
        </div>
    </div> <!--end container-->
</section><!--end section-->
<!-- Hero End -->

<!-- Shape Start -->
<div class="position-relative">
    <div class="shape overflow-hidden text-color-white">
        <svg viewBox="0 0 2880 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0 48H1437.5H2880V0H2160C1442.5 52 720 0 720 0H0V48Z" fill="currentColor"></path>
        </svg>
    </div>
</div>
<!--Shape End-->

<!-- Registration Form Start -->
<section class="section">
    <div class="container mt-100 mt-60">
        <div class="row align-items-center">
            <div class="col-lg-6 col-md-6 mt-4 mt-sm-0 pt-2 pt-sm-0 order-2 order-md-1">
                <div class="card custom-form rounded border-0 shadow p-4">
                    <div class="app-brand justify-content-center mb-4">
                        <a href="{% url 'index' %}" class="app-brand-link gap-2">
                            <span class="app-brand-logo demo">
                                <img src="{% static 'home/assets/images/logo-dark.png'%}" alt="Career Wader" />
                            </span>
                        </a>
                    </div>
                    
                    <form class="d-block" id="formAuthentication" class="login-form">
                        {% csrf_token %}
                        <input type="text" name="user" value="1" hidden />
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        First Name <span class="text-danger">*</span>
                                    </label>
                                    <div class="form-icon position-relative">
                                        <i data-feather="user" class="fea icon-sm icons"></i>
                                        <input
                                            type="text"
                                            class="form-control ps-5"
                                            placeholder="First Name"
                                            id="first_name"
                                            name="first_name"
                                            required
                                        />
                                    </div>
                                </div>
                            </div>
                        
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        Last Name <span class="text-danger">*</span>
                                    </label>
                                    <div class="form-icon position-relative">
                                        <i data-feather="user" class="fea icon-sm icons"></i>
                                        <input
                                            type="text"
                                            class="form-control ps-5"
                                            placeholder="Last Name"
                                            id="last_name"
                                            name="last_name"
                                            required
                                        />
                                    </div>
                                </div>
                            </div>
                        
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        Email <span class="text-danger">*</span>
                                    </label>
                                    <div class="form-icon position-relative">
                                        <i data-feather="mail" class="fea icon-sm icons"></i>
                                        <input
                                            type="email"
                                            class="form-control ps-5"
                                            id="email"
                                            placeholder="Email"
                                            name="email"
                                            required
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        Password <span class="text-danger">*</span>
                                    </label>
                                    <div class="form-icon position-relative">
                                        <i data-feather="lock" class="fea icon-sm icons"></i>
                                        <input
                                            type="password"
                                            class="form-control ps-5"
                                            placeholder="Password"
                                            id="password"
                                            name="password"
                                            required
                                        />
                                    </div>
                                </div>
                            </div>
                        
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        Phone <span class="text-danger">*</span>
                                    </label>
                                    <div class="form-icon position-relative">
                                        <i data-feather="phone" class="fea icon-sm icons"></i>
                                        <input
                                            type="tel"
                                            class="form-control ps-5"
                                            placeholder="Phone Number"
                                            id="phone"
                                            name="phone"
                                            required
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        Country <span class="text-danger">*</span>
                                    </label>
                                    <div class="form-icon position-relative">
                                        <i data-feather="globe" class="fea icon-sm icons"></i>
                                        <select name="country" class="form-control ps-5" id="country" required>
                                            <option value="IN">India</option>
                                            <option value="ID">Indonesia</option>
                                            <option value="IR">Iran</option>
                                            <option value="HU">Hungary</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        
                            <div class="col-lg-12 mb-0">
                                <div class="d-grid">
                                    <button class="btn btn-primary" type="submit">Sign Up</button>
                                </div>
                            </div>
                            
                            <div class="col-lg-12 mt-3 text-center">
                                <p class="mb-0">
                                    <span>Already have an account?</span>
                                    <a href="{% url 'login'%}" class="text-primary fw-bold">
                                        Sign in instead
                                    </a>
                                </p>
                            </div>
                        </div>
                    </form>
                    
                    <div id="otpFormContainer" class="d-none">

                        <h3 class="text-center mb-4">Verification Code</h3>
                        <p class="text-center text-muted mb-4">Please enter the 6 digit code sent to your device</p>
                        
                        <form action ="{% url 'submitOtp' %}" method="POST">
                            {% csrf_token %}
                        <input name="email" type="hidden" id="emailField"/>
                        <div class="otp-input-container d-flex justify-content-center gap-2 mb-4">
                            <input type="text" class="form-control text-center fw-bold otpField" name="digit-1" maxlength="1" autocomplete="off" required  id="digit-1">
                            <input type="text" class="form-control text-center fw-bold otpField" name="digit-2" maxlength="1" autocomplete="off" required  id="digit-2">
                            <input type="text" class="form-control text-center fw-bold otpField" name="digit-3" maxlength="1" autocomplete="off" required  id="digit-3">
                            <input type="text" class="form-control text-center fw-bold otpField" name="digit-4" maxlength="1" autocomplete="off" required  id="digit-4">
                            <input type="text" class="form-control text-center fw-bold otpField" name="digit-5" maxlength="1" autocomplete="off" required  id="digit-5">
                            <input type="text" class="form-control text-center fw-bold otpField" name="digit-6" maxlength="1" autocomplete="off" required  id="digit-6">
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary py-2 fw-bold" id="verifyBtn">Verify</button>
                        </div>
                        </form>

                    </div>

                </div><!--end custom-form-->
            </div><!--end col-->

            <div class="col-lg-6 col-md-6 order-1 order-md-2">
                <div class="title-heading ms-lg-4">
                    <h4 class="mb-4">Welcome to Career Wader Dashboard 🚀</h4>

                    <p class="text-muted">Make your <span class="text-primary fw-bold">app management</span> easy and fun!</p>

                    <p class="text-muted">Career Wader is designed to help you navigate your academic and professional journey with ease. Sign up now to access personalized career guidance, educational resources, and expert support.</p>
                    
                    <div class="d-flex contact-detail align-items-center mt-3">
                        <div class="icon">
                            <i data-feather="check-circle" class="fea icon-m-md text-dark me-3"></i>
                        </div>
                        <div class="flex-1 content">
                            <h6 class="title fw-bold mb-0">Personalized Career Guidance</h6>
                            <p class="text-muted mb-0">Tailored advice for your unique career path</p>
                        </div>
                    </div>
                    
                    <div class="d-flex contact-detail align-items-center mt-3">
                        <div class="icon">
                            <i data-feather="check-circle" class="fea icon-m-md text-dark me-3"></i>
                        </div>
                        <div class="flex-1 content">
                            <h6 class="title fw-bold mb-0">Comprehensive Resources</h6>
                            <p class="text-muted mb-0">Access to educational materials and career tools</p>
                        </div>
                    </div>
                    
                    <div class="d-flex contact-detail align-items-center mt-3">
                        <div class="icon">
                            <i data-feather="check-circle" class="fea icon-m-md text-dark me-3"></i>
                        </div>
                        <div class="flex-1 content">
                            <h6 class="title fw-bold mb-0">Expert Support</h6>
                            <p class="text-muted mb-0">Guidance from industry professionals</p>
                        </div>
                    </div>
                </div>
            </div><!--end col-->
        </div><!--end row-->
    </div><!--end container-->
</section><!--end section-->

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-success mb-3" role="status" style="width: 3rem; height: 3rem">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="mt-3">Processing your registration...</h5>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    
    $("#formAuthentication").on("submit", function (e) {
        e.preventDefault();

        // Show loading modal
        const loadingModal = new bootstrap.Modal(document.getElementById("loadingModal"));
        loadingModal.show();

        const data = {
            user: {
                first_name: $("#first_name").val(),
                last_name: $("#last_name").val(),
                email: $("#email").val(),
                password: $("#password").val(),
                phone: $("#phone").val(),
                country: $("#country").val(),
                is_active: true,
            },
        };

        const role = "{{ role|escape }}";
        const baseUrl = "{{ api_base_url|escape }}";
        console.log(`${baseUrl}api/${role}/register/`);
        axios.post(`${baseUrl}api/${role}/register/`, data)
        .then(function (response) {
            // Hide loading modal
            loadingModal.hide();
            $('#emailField').val(response.data.user.email);
            $('#otpFormContainer').removeClass('d-none');  // Show OTP form
            $('#formAuthentication').addClass('d-none'); 

            Swal.fire({
                title: "OTP Sent Successfully!",
                text: "An OTP has been sent to your mail.",
                icon: "success",
                confirmButtonText: "Continue",
            }).then((result) => {
                if (result.isConfirmed) {
                   
                }
            });
        })
        .catch(function (error) {
            // Hide loading modal
            loadingModal.hide();

            console.error(error.response?.data);

            let errorMessage = "Failed to register. Please try again.";
            const errorData = error.response?.data || {};
            const status = error.response?.status;

            if (status === 500) {
                errorMessage = "Internal Server Error. Please try again later.";
            } else if (status === 404) {
                errorMessage = "API endpoint not found.";
            } else if (status === 403) {
                errorMessage = "You do not have permission to perform this action.";
            } else if (status === 400 && typeof errorData === 'object') {
                // Extract validation errors
                let messageList = [];

                if (errorData.user) {
                    const userErrors = errorData.user;

                    if (userErrors.email) {
                        messageList.push("Email: " + userErrors.email.join(" "));
                    }
                    if (userErrors.phone) {
                        messageList.push("Phone: " + userErrors.phone.join(" "));
                    }

                    // Handle any other user fields
                    Object.keys(userErrors).forEach((key) => {
                        if (key !== "email" && key !== "phone") {
                            messageList.push(
                                key.charAt(0).toUpperCase() + key.slice(1) + ": " + userErrors[key].join(" ")
                            );
                        }
                    });
                } else {
                    // General field-level validation errors
                    Object.keys(errorData).forEach((key) => {
                        const messages = errorData[key];
                        if (Array.isArray(messages)) {
                            messageList.push(`${key.charAt(0).toUpperCase() + key.slice(1)}: ${messages.join(" ")}`);
                        }
                    });
                }

                if (messageList.length > 0) {
                    errorMessage = messageList.join("\n");
                }
            } else if (error.request) {
                errorMessage = "No response from the server. Please check your internet connection.";
            } else if (error.message) {
                errorMessage = `Request error: ${error.message}`;
            }

            Swal.fire({
                title: "Registration Failed!",
                text: errorMessage,
                icon: "error",
            });
    });

    });
</script>
{% endblock %}