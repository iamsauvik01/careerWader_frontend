{% extends "home/layouts/base.html" %}
{% load static  %}

{% block content %}
<section class="bg-half-170 bg-light d-table w-100">
    <div class="container">
        <div class="row mt-5 justify-content-center">
            <div class="col-lg-12 text-center">
                <div class="pages-heading">
                    <h4 class="title mb-0"> Login </h4>
                </div>
            </div>  <!--end col-->
        </div><!--end row-->
        
        <div class="position-breadcrumb">
            <nav aria-label="breadcrumb" class="d-inline-block">
                <ul class="breadcrumb rounded shadow mb-0 px-4 py-2">
                    <li class="breadcrumb-item"><a href="#">Page</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Login</li>
                </ul>
            </nav>
        </div>
    </div> <!--end container-->
</section><!--end section-->
<!-- Hero End -->

<!-- Shape Start -->
<div class="position-relative">
    <div class="shape overflow-hidden text-color-white">
        <svg viewBox="0 0 2880 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0 48H1437.5H2880V0H2160C1442.5 52 720 0 720 0H0V48Z" fill="currentColor"></path>
        </svg>
    </div>
</div>
<!--Shape End-->

<!-- Login Form Start -->
<section class="section">
    <div class="container mt-100 mt-60">
        <div class="row align-items-center">
            <div class="col-lg-6 col-md-6 mt-4 mt-sm-0 pt-2 pt-sm-0 order-2 order-md-1">
                <div class="card custom-form rounded border-0 shadow p-4">
                    <div class="app-brand justify-content-center mb-4">
                        <a href="{% url 'index' %}" class="app-brand-link gap-2">
                            <span class="app-brand-logo demo">
                                <img src="{% static 'home/assets/images/logo-dark.png'%}" alt="Career Wader" />
                            </span>
                        </a>
                    </div>
                    
                    <form id="formAuthentication" class="login-form">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="mb-3">
                                    <label class="form-label">
                                        Email or Username <span class="text-danger">*</span>
                                    </label>
                                    <div class="form-icon position-relative">
                                        <i data-feather="user" class="fea icon-sm icons"></i>
                                        <input
                                            type="text"
                                            class="form-control ps-5"
                                            placeholder="Enter your email or username"
                                            id="email"
                                            name="email-username"
                                            autofocus
                                            required
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-12">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <label class="form-label">
                                            Password <span class="text-danger">*</span>
                                        </label>
                                        <a href="auth-forgot-password-basic.html" class="text-primary fw-bold">
                                            <small>Forgot Password?</small>
                                        </a>
                                    </div>
                                    <div class="form-icon position-relative">
                                        <i data-feather="lock" class="fea icon-sm icons"></i>
                                        <input
                                            type="password"
                                            class="form-control ps-5"
                                            placeholder="Enter your password"
                                            id="password"
                                            name="password"
                                            required
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-12">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="remember-me" />
                                        <label class="form-check-label" for="remember-me"> Remember Me </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-12 mb-0">
                                <div class="d-grid">
                                    <button class="btn btn-primary" type="submit">Sign In</button>
                                </div>
                            </div>
                            
                            {% comment %} <div class="col-lg-12 mt-3 text-center">
                                <p class="mb-0">
                                    <span>New on our platform?</span>
                                    <a href="{% url 'register'%}" class="text-primary fw-bold">
                                        Create an account
                                    </a>
                                </p>
                            </div> {% endcomment %}
                        </div>
                    </form>
                </div><!--end custom-form-->
            </div><!--end col-->

            <div class="col-lg-6 col-md-6 order-1 order-md-2">
                <div class="title-heading ms-lg-4">
                    <h4 class="mb-4">Welcome to Career Wader Dashboard! ðŸ‘‹</h4>

                    <p class="text-muted">Please sign in to your account and <span class="text-primary fw-bold">start the adventure</span> with Career Wader.</p>

                    <p class="text-muted">Career Wader helps you navigate your academic and professional journey with personalized guidance, educational resources, and expert support.</p>
                    
                    <div class="d-flex contact-detail align-items-center mt-3">
                        <div class="icon">
                            <i data-feather="check-circle" class="fea icon-m-md text-dark me-3"></i>
                        </div>
                        <div class="flex-1 content">
                            <h6 class="title fw-bold mb-0">Access Your Dashboard</h6>
                            <p class="text-muted mb-0">Track your progress and goals in one place</p>
                        </div>
                    </div>
                    
                    <div class="d-flex contact-detail align-items-center mt-3">
                        <div class="icon">
                            <i data-feather="check-circle" class="fea icon-m-md text-dark me-3"></i>
                        </div>
                        <div class="flex-1 content">
                            <h6 class="title fw-bold mb-0">Personalized Experience</h6>
                            <p class="text-muted mb-0">Get recommendations tailored to your profile</p>
                        </div>
                    </div>
                    
                    <div class="d-flex contact-detail align-items-center mt-3">
                        <div class="icon">
                            <i data-feather="check-circle" class="fea icon-m-md text-dark me-3"></i>
                        </div>
                        <div class="flex-1 content">
                            <h6 class="title fw-bold mb-0">Secure Login</h6>
                            <p class="text-muted mb-0">Your data is protected with industry-standard security</p>
                        </div>
                    </div>
                </div>
            </div><!--end col-->
        </div><!--end row-->
    </div><!--end container-->
</section><!--end section-->

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-success mb-3" role="status" style="width: 3rem; height: 3rem">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="mt-3">Signing in...</h5>
            </div>
        </div>
    </div>
</div>

{% if messages %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    {% for message in messages %}
        Swal.fire({
            icon: 'warning',
            title: 'Oops!',
            text: '{{ message }}',
        });
    {% endfor %}
</script>
{% endif %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const redirectURL = "{% url 'dashboard' %}";
</script>

<script>
// Declare loadingModal globally so it can be reused
let loadingModal;

$('#formAuthentication').on('submit', function(e) {
    e.preventDefault();
    
    // Initialize or get the loading modal instance
    if (!loadingModal) {
        loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    }
    
    // Ensure modal is hidden before showing (in case it's stuck from previous attempt)
    loadingModal.hide();
    
    // Small delay to ensure previous hide operation completes
    setTimeout(() => {
        loadingModal.show();
    }, 100);

    const data = {
        email: $('#email').val(),
        password: $('#password').val()
    };
   
    const baseUrl = "{{ api_base_url|escape }}";
    axios.post(`${baseUrl}api/token/`, data)
    .then(function(response) {
        // Hide loading modal
        loadingModal.hide();
        
        const accessToken = response.data.access;
        const refreshToken = response.data.refresh;
        const role = response.data.role;

        // Set tokens in cookies (expires in 1 hour and 1 day respectively)
        document.cookie = `access_token=${accessToken}; path=/; max-age=3600`;
        document.cookie = `refresh_token=${refreshToken}; path=/; max-age=86400`;
        document.cookie = `role=${role}; path=/; max-age=86400`;

        // Redirect after successful login
        window.location.href = redirectURL;
    })
    .catch(function(error) {
        // Ensure loading modal is hidden
        loadingModal.hide();

        let title = 'Login Failed!';
        let message = 'An error occurred. Please try again later.';
        
        if (error.response) {
            const status = error.response.status;
            switch (status) {
                case 400:
                    message = 'Bad request. Please check your input.';
                    break;
                case 401:
                    message = 'Unauthorized. Invalid username or password.';
                    break;
                case 403:
                    message = 'Forbidden. You do not have access.';
                    break;
                case 404:
                    message = 'API endpoint not found.';
                    break;
                case 500:
                    message = 'Internal Server Error. Please try again later.';
                    break;
                default:
                    message = error.response.data?.detail || message;
            }
        } else if (error.request) {
            message = 'No response from the server. Please check your internet connection.';
        } else {
            message = 'Request setup error: ' + error.message;
        }

        // Add a small delay before showing SweetAlert to ensure loading modal is fully hidden
        setTimeout(() => {
            Swal.fire({
                title: title,
                text: message,
                icon: 'error',
                confirmButtonText: 'Try Again'
            });
        }, 200);
    });
});
</script>
{% endblock %}